<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#0b0f19">
<!-- iOS ì „ìš© -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="ë°ì´íŠ¸ì¼ì§€">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">


  <title>ìš°ë¦¬ ë°ì´íŠ¸ ì¼ì§€</title>
  <style>
    :root{
      --bg:#0b0f19;
      --card:#121a2a;
      --card2:#0f1626;
      --text:#e9eefc;
      --muted:#aab6d6;
      --line:#24304d;
      --accent:#7aa2ff;
      --accent2:#ff7ab6;
      --good:#5eead4;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      font-synthesis-weight:none;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(122,162,255,.20), transparent 55%),
                  radial-gradient(900px 500px at 90% 10%, rgba(255,122,182,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      letter-spacing:-0.2px;
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:18px 20px;border:1px solid var(--line);border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(18,26,42,.92), rgba(15,22,38,.86));
      box-shadow:var(--shadow);
      position:sticky;top:16px;backdrop-filter: blur(10px);
      z-index:5;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 20px rgba(122,162,255,.22);
    }
    .title{display:flex;flex-direction:column;line-height:1.15}
    .title strong{font-size:16px}
    .title span{font-size:12px;color:var(--muted)}
    .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      border:1px solid var(--line);background:rgba(0,0,0,.20);
      padding:8px 10px;border-radius:999px;color:var(--muted);
      display:flex;gap:8px;align-items:center;font-size:12px;
    }
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
      transition:transform .05s ease, background .15s ease, border-color .15s ease;
      font-weight:650;
    }
    .btn:hover{background:rgba(255,255,255,.08);border-color:#334066}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      border-color:rgba(122,162,255,.55);
      background:linear-gradient(135deg, rgba(122,162,255,.22), rgba(255,122,182,.16));
    }
    .btn.danger{border-color:rgba(251,113,133,.55);background:rgba(251,113,133,.10)}
    main{margin-top:18px;display:grid;grid-template-columns: 1.2fr .8fr; gap:16px}
    @media (max-width: 980px){ main{grid-template-columns:1fr;}}
    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(18,26,42,.92), rgba(15,22,38,.86));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 18px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .card .hd h2{margin:0;font-size:15px}
    .card .bd{padding:16px 18px}
    .grid{display:grid;grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 580px){ .grid{grid-template-columns:1fr;} }
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input, textarea, select{
      width:100%;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid var(--line);
      border-radius:var(--radius2);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      padding:12px 12px;
      display:flex;gap:12px;align-items:flex-start;justify-content:space-between;
    }
    .meta{display:flex;flex-direction:column;gap:6px;min-width:0}
    .meta .top{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .tag{
      font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);
      color:var(--muted);background:rgba(0,0,0,.12);
    }
    .mood{border-color:rgba(122,162,255,.35)}
    .mood.good{border-color:rgba(94,234,212,.5); color:rgba(94,234,212,.95)}
    .mood.ok{border-color:rgba(251,191,36,.5); color:rgba(251,191,36,.95)}
    .mood.bad{border-color:rgba(251,113,133,.55); color:rgba(251,113,133,.95)}
    .ttl{
      font-weight:800;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:520px;
    }
    .desc{
      color:var(--muted);font-size:13px;line-height:1.45;
      overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
      max-width:680px;
    }
    .actions{display:flex;gap:8px;flex-shrink:0}
    .kpi{display:grid;grid-template-columns:1fr 1fr; gap:10px}
    .stat{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 12px;
      background:rgba(0,0,0,.16);
    }
    .stat b{display:block;font-size:18px}
    .stat span{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:var(--line);margin:14px 0}
    .search{display:flex;gap:8px;align-items:center}
    .search input{flex:1}
    .small{font-size:12px;color:var(--muted)}
    .modal{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;padding:18px;z-index:50;
    }
    .modal.on{display:flex}
    .modal .box{
      width:min(720px, 100%);
      border:1px solid var(--line);
      border-radius:22px;
      background:linear-gradient(180deg, rgba(18,26,42,.98), rgba(15,22,38,.96));
      box-shadow:0 20px 60px rgba(0,0,0,.5);
      overflow:hidden;
    }
    .modal .box .hd{padding:16px 18px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .modal .box .bd{padding:16px 18px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(18,26,42,.96);
      border:1px solid var(--line);
      padding:10px 12px;border-radius:999px;
      display:none;gap:10px;align-items:center;
      box-shadow:var(--shadow);z-index:60;
    }
    .toast.on{display:flex}
    .toast .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(135deg,var(--accent),var(--accent2))}
    input[type="file"] {
  display: block !important;
}
input[type="file"] {
  display: block !important;
  opacity: 1 !important;
  position: static !important;
  width: 100% !important;
  height: auto !important;
}
/* ===== Mobile responsive ===== */

/* ê¸°ë³¸ì ìœ¼ë¡œ ì´ë¯¸ì§€/ì¸í’‹ì´ í™”ë©´ ë°–ìœ¼ë¡œ íŠ€ëŠ” ê±° ë°©ì§€ */
img { max-width: 100%; height: auto; }
input, select, textarea, button { max-width: 100%; }

/* iPhone ë…¸ì¹˜ ì•ˆì „ì˜ì—­ */
.wrap {
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
}

/* 1024 ì´í•˜: ì—¬ë°± ì‚´ì§ ì¤„ì´ê¸° */
@media (max-width: 1024px){
  .wrap { padding: 16px; }
}

/* 860 ì´í•˜: 2ì»¬ëŸ¼ -> 1ì»¬ëŸ¼(ì„¸ë¡œ) */
@media (max-width: 860px){
  main{
    /* ë„ˆí¬ mainì´ grid/flex ë­ë“  ìƒê´€ì—†ì´ â€œì„¸ë¡œâ€ë¡œ ê°•ì œ */
    display: flex !important;
    flex-direction: column !important;
    gap: 12px !important;
  }

  /* ì¹´ë“œ í­ ê½‰ ì±„ìš°ê¸° */
  .card { width: 100% !important; }

  /* ìƒë‹¨(í—¤ë”) ë²„íŠ¼ë“¤: ì¤„ë°”ê¿ˆ í—ˆìš© */
  .right{
    justify-content: flex-start !important;
    flex-wrap: wrap !important;
    gap: 8px !important;
  }
  .pill, .btn{
    padding: 10px 12px !important;
    font-size: 13px !important;
  }

  /* ì…ë ¥ í¼: ê·¸ë¦¬ë“œê°€ 2ì¹¸ì´ë©´ 1ì¹¸ìœ¼ë¡œ */
  .grid{
    display: grid !important;
    grid-template-columns: 1fr !important;
    gap: 10px !important;
  }

  /* textarea ë†’ì´ ì¡°ê¸ˆ ëŠ˜ë ¤ì„œ ëª¨ë°”ì¼ íƒ€ì´í•‘ í¸í•˜ê²Œ */
  textarea{
    min-height: 140px !important;
  }

  /* ê²€ìƒ‰ì°½/ì…ë ¥ì°½ í„°ì¹˜ í¸í•˜ê²Œ */
  input, select, textarea{
    font-size: 16px !important; /* iOS ìë™ì¤Œ ë°©ì§€ */
  }
}

/* 420 ì´í•˜: ë” ì´˜ì´˜í•˜ê²Œ */
@media (max-width: 420px){
  .wrap { padding: 12px; }
  .pill, .btn{
    width: auto;
    min-height: 40px;
  }
}
  /* âœ… D-day ìœ„ì ¯ */
.ddayWidget{
  margin-top: 10px;
  padding: 12px;
  border-radius: 14px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.12);
  backdrop-filter: blur(10px);
}
.ddayTop{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:10px;
}
#ddayText{
  font-weight: 800;
  letter-spacing: -0.2px;
}
.ddayRow{
  display:flex;
  gap:8px;
}
.ddayRow input{
  flex:1;
}
.ddayRow button{
  padding: 10px 12px;
  border-radius: 12px;
}
/* ===== D-day ìœ„ì ¯ ===== */
.dday {
  font-size: 18px;
  font-weight: bold;
  text-align: center;
  margin-bottom: 12px;
}
.annivAuto{
  font-size: 14px;
  text-align: center;
  opacity: 0.9;
  margin-bottom: 14px;
}
.ddayWidget{ display:flex; gap:8px; align-items:center; }
#ddayText{ font-weight:700; }

.dday-card{
  position: sticky;
  top: 0;
  z-index: 10;
  background: white;
  border-radius: 18px;
  padding: 16px;
  margin: 12px 0;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
}

.dday-title{ font-size: 14px; opacity: 0.7; }
.dday-value{ font-size: 34px; font-weight: 800; margin-top: 6px; }
.dday-sub{ font-size: 13px; opacity: 0.65; margin-top: 6px; }

.dday-btn{
  margin-top: 12px;
  width: 100%;
  padding: 10px 12px;
  border-radius: 12px;
  border: 0;
  background: #111;
  color: white;
  font-weight: 700;
  cursor: pointer;
}

.modal.hidden{ display:none; }
.modal{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99;
}

.modal-box{
  width: min(360px, 92vw);
  background: white;
  border-radius: 18px;
  padding: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.modal-title{ font-weight: 800; font-size: 16px; }
.modal-input{
  width: 100%;
  margin-top: 12px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(0,0,0,0.15);
}

.modal-actions{
  display:flex;
  gap: 8px;
  margin-top: 12px;
}

.modal-btn{
  flex:1;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(0,0,0,0.15);
  background: white;
  cursor: pointer;
  font-weight: 700;
}

.modal-btn.primary{
  background:#111;
  color:white;
  border:0;
}
/* import ëª¨ë‹¬ì´ í•­ìƒ ìµœìƒë‹¨ */
#modalImport { 
  position: fixed;
  inset: 0;
  z-index: 99999;
}

/* ëª¨ë‹¬ ì•ˆ ë‚´ìš©(íŒ¨ë„)ì€ í´ë¦­ ê°€ëŠ¥ + ì˜¤ë²„ë ˆì´ë³´ë‹¤ ìœ„ */
#modalImport .box,
#modalImport .panel,
#modalImport .content,
#modalImport .wrap,
#modalImport .container {
  position: relative;
  z-index: 100000;
  pointer-events: auto;
}

/* í˜¹ì‹œ ëª¨ë‹¬ ë°°ê²½(ì˜¤ë²„ë ˆì´)ì´ ë²„íŠ¼ ìœ„ë¥¼ ë®ëŠ” ê²½ìš°ë¥¼ ë°©ì§€ */
#modalImport .hd, 
#modalImport button {
  position: relative;
  z-index: 100001;
  pointer-events: auto;
}
#modalImport {
  position: fixed;
  inset: 0;
  z-index: 99999;
}

#modalImport button {
  position: relative;
  z-index: 100000;
  pointer-events: auto;
}


  </style>

</head>
<body>
  <section id="ddayCard" class="dday-card">
    <div class="dday-title">ìš°ë¦¬ ì‚¬ê·„ì§€</div>
    <div class="dday-value" id="ddayValue">D+0</div>
    <div class="dday-sub" id="ddaySub">ê¸°ë…ì¼ì„ ì„¤ì •í•´ì¤˜</div>
  
    <button class="dday-btn" id="openSettingBtn">ê¸°ë…ì¼ ì„¤ì •</button>
  </section>
  
  <!-- ì„¤ì • ëª¨ë‹¬ -->
  <div id="ddayModal" class="modal hidden">
    <div class="modal-box">
      <div class="modal-title">ì‚¬ê·„ ë‚  ì„¤ì •</div>
  
      <input type="date" id="startDateInput" class="modal-input" />
  
      <div class="modal-actions">
        <button id="saveStartDateBtn" class="modal-btn primary">ì €ì¥</button>
        <button id="closeModalBtn" class="modal-btn">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
  
  <div class="wrap">
    <div id="ddayBox" class="dday">
      <div id="annivAuto" class="annivAuto"></div>
      ğŸ’• D+<span id="ddayCount">0</span>
    </div>
    <header>
      <!-- D-day ìœ„ì ¯ -->
<div class="ddayWidget">
  <input type="date" id="annivDate" />
  <button id="btnSaveAnniv">ì €ì¥</button>
  <span id="ddayText">D+0</span>
</div>
<div id="annivAuto"></div>

      <div class="brand">
        <div class="logo">â™¥</div>
        <div class="title">
          <strong>ìš°ë¦¬ ë°ì´íŠ¸ ì¼ì§€</strong>
          <span id="subtitle">í•œ ë²ˆì˜ í´ë¦­ìœ¼ë¡œ ì¶”ì–µ ì €ì¥ âœ¨</span>
        </div>
      </div>
      <div class="right">
        <div class="pill">
          <span>ì»¤í”Œì½”ë“œ</span>
          <b id="coupleCodeLabel" class="mono">-</b>
        </div>
        <!-- âœ… D-day ìœ„ì ¯ -->
        <div class="ddayWidget">
        <div class="ddayTop">
        <b>ì‚¬ê·„ ë‚ </b>
        <span id="ddayText">D+0</span>
        </div>

        <div class="ddayRow">
        <input type="date" id="annivDate" />
        <button type="button" id="btnSaveAnniv">ì €ì¥</button>
        </div>
        </div>

        <button class="btn" id="btnExport">ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn" id="btnImport">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn danger" id="btnReset">ì´ˆê¸°í™”</button>
        <button class="btn primary" id="btnCouple">ì»¤í”Œì½”ë“œ ì„¤ì •</button>
      </div>
     

    </header>

    <main>
      <!-- Left: Add / Edit -->
      <section class="card">
        <div class="hd">
          <h2 id="formTitle">ìƒˆ ë°ì´íŠ¸ ê¸°ë¡</h2>
          <div class="row" style="gap:8px;flex-wrap:nowrap">
            <button class="btn" id="btnClear">í¼ ë¹„ìš°ê¸°</button>
            <button class="btn primary" id="btnSave">ì €ì¥</button>
          </div>
        </div>
        
        <div class="bd">
          <div class="grid">
            <div>
              <label>ëŒ€í‘œ ì‚¬ì§„ (1ì¥)</label>
              <input type="file" id="coverImageInput" accept="image/*">
              <img id="coverPreview"
                   style="max-width:100%; display:none; border-radius:12px; margin-top:8px;" />
            </div>
            
            <div>
              <label>ë³¸ë¬¸ ì‚¬ì§„ (ì—¬ëŸ¬ ì¥)</label>
              <label>ë³¸ë¬¸ ì‚¬ì§„ (ì—¬ëŸ¬ ì¥)</label>

              <button type="button" id="btnAddPhotos">ì‚¬ì§„ ì¶”ê°€</button>

              <input type="file"
                id="photosInput"
                accept="image/*"
                multiple
                style="display:none"
              />

              <div id="photosPreview"
                  style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
              </div>

            
              <div>
                <label>ì‚¬ê·„ ë‚ </label>
                <input type="date" id="loveStartDate" />
              </div>
              
            <div>
              <label>ë‚ ì§œ</label>
              <input type="date" id="date" />
            </div>
            <div>
              <label>ì¥ì†Œ</label>
              <input type="text" id="place" placeholder="ì˜ˆ) ì „ì£¼ í•œì˜¥ë§ˆì„, ë…¸ë“¤ì„¬â€¦" />
            </div>
          </div>

          <div class="grid" style="margin-top:12px">
            <div>
              <label>ì œëª©</label>
              <input type="text" id="title" placeholder="ì˜ˆ) ì²« í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ë°ì´íŠ¸" />
            </div>
            <div>
              <label>ë¶„ìœ„ê¸°(ë¬´ë“œ)</label>
              <select id="mood">
                <option value="good">ì¢‹ìŒ ğŸ˜Š</option>
                <option value="ok">ë³´í†µ ğŸ™‚</option>
                <option value="bad">ë³„ë¡œ ğŸ˜¶</option>
              </select>
            </div>
          </div>

          <div style="margin-top:12px">
            <label>í•œ ì¤„ ìš”ì•½</label>
            <input type="text" id="summary" placeholder="ì˜ˆ) ë¹„ê°€ ì™€ì„œ ë” ë‚­ë§Œì ì´ì—ˆìŒ" />
          </div>

          <div style="margin-top:12px">
            <label>ë³¸ë¬¸</label>
            <textarea id="content" placeholder="ê·¸ë‚  ìˆì—ˆë˜ ì¼, ëŒ€í™”, ëŠë‚€ ì ì„ ì ì–´ì¤˜. (ì§§ì•„ë„ ë¨)"></textarea>
            <div class="hint">íŒ: ë‚˜ì¤‘ì— ê²€ìƒ‰í•˜ê¸° ì‰½ë„ë¡ í‚¤ì›Œë“œë¥¼ ë„£ì–´ë‘ë©´ ì¢‹ì•„.</div>
          </div>

          <div class="divider"></div>

          <div class="grid">
            <div>
              <label>íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
              <input type="text" id="tags" placeholder="ì˜ˆ) ë§›ì§‘, ì‚°ì±…, ì˜í™”, ê¸°ë…ì¼" />
            </div>
            <div>
              <label>ë¹„ìš©(ì›)</label>
              <input type="number" id="cost" placeholder="ì˜ˆ) 45000" min="0" />
            </div>
          </div>

          <div class="hint small" id="editHint" style="margin-top:10px;display:none">
            í¸ì§‘ ì¤‘â€¦ ì €ì¥í•˜ë©´ í•´ë‹¹ ê¸°ë¡ì´ ìˆ˜ì •ë¼.
          </div>
        </div>
      </section>

      <!-- Right: List / Stats -->
      <aside class="card">
        <div class="hd">
          <h2>ê¸°ë¡ ëª©ë¡</h2>
          <div class="search">
            <input type="text" id="q" placeholder="ê²€ìƒ‰ (ì œëª©/ì¥ì†Œ/íƒœê·¸/ë³¸ë¬¸)" />
          </div>
        </div>
        <div class="bd">
          <div class="kpi">
            <div class="stat">
              <b id="kpiCount">0</b>
              <span>ì´ ê¸°ë¡</span>
            </div>
            <div class="stat">
              <b id="kpiCost">0ì›</b>
              <span>ì´ ë¹„ìš©(í•©ê³„)</span>
            </div>
          </div>
          <div class="divider"></div>
          <div class="list" id="list"></div>
          <div class="small" id="empty" style="display:none; margin:10px;">

            ì•„ì§ ê¸°ë¡ì´ ì—†ì–´. ì™¼ìª½ì—ì„œ ì²« ë°ì´íŠ¸ ì¼ì§€ë¥¼ ì €ì¥í•´!
          </div>

           

          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Couple Code Modal -->
  <div class="modal" id="modal">
    <div class="box">
      <div class="hd">
        <b>ì»¤í”Œì½”ë“œ ì„¤ì •</b>
        <button class="btn" id="btnClose">ë‹«ê¸°</button>
      </div>
      <div class="bd">
        <label>ì»¤í”Œì½”ë“œ (ë‘˜ì´ ê°™ì€ ì½”ë“œë¡œ ë§ì¶”ê¸°)</label>
        <input id="coupleCode" class="mono" placeholder="ì˜ˆ) GAYOUNG-LOVE-2025" />
        <div class="hint">
          ì´ ì½”ë“œëŠ” <b>ì €ì¥ ê³µê°„(ë¡œì»¬)</b>ì„ ë¶„ë¦¬í•˜ëŠ” ì—­í• ì´ì•¼. ì„œë¡œ ê°™ì€ ì»´í“¨í„°/ë¸Œë¼ìš°ì €ê°€ ì•„ë‹ˆë©´ ìë™ ë™ê¸°í™”ëŠ” ì•ˆ ë¼.
        </div>
        <div class="divider"></div>
        <button class="btn primary" id="btnSetCode">ì ìš©</button>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div class="modal" id="modalImport">
    <div class="box">
      <div class="hd">
        <b>ë¶ˆëŸ¬ì˜¤ê¸° (JSON)</b>
        <button class="btn" id="btnCloseImport">ë‹«ê¸°</button>

      </div>
      <div class="bd">
        <label>ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°</label>
        <textarea id="importText" class="mono" placeholder='{"coupleCode":"...","entries":[...]}'></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnImportMerge">í•©ì¹˜ê¸°(ì¶”ê°€)</button>
          <button class="btn danger" id="btnImportReplace">ë®ì–´ì“°ê¸°</button>
        </div>
        <div class="hint">í•©ì¹˜ê¸°ëŠ” ê¸°ì¡´ ê¸°ë¡ì„ ìœ ì§€í•˜ê³  ìƒˆ ê¸°ë¡ì„ ì¶”ê°€í•´.</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="dot"></div>
    <div id="toastText" class="small">ì €ì¥ë¨</div>
  </div>

<script>
  // ===== D-day (annivDate + ddayText) =====
function renderDDay(){
  const elInput = document.getElementById("annivDate");
  const elText  = document.getElementById("ddayText");
  if(!elInput || !elText) return;

  const saved = localStorage.getItem("annivDate") || "";

const btn = document.getElementById("btnSaveAnniv");
const inp = document.getElementById("annivDate");

if (btn) {
  btn.onclick = () => {
    if (!inp?.value) {
      alert("ì‚¬ê·„ ë‚  ë‚ ì§œë¥¼ ì„ íƒí•´ì¤˜!");
      return;
    }
    localStorage.setItem("annivDate", inp.value);
    renderDDay();
  };
}

if (inp) inp.addEventListener("change", renderDDay);

function renderDDay() {
  const dDayText = document.getElementById("dDayText");
  if (!dDayText) return;

  const start = localStorage.getItem("annivDate");
  if (!start) {
    dDayText.textContent = "D-day ì„¤ì • í•„ìš”";
    return;
  }

  const startDate = new Date(start + "T00:00:00");
  const today = new Date();
  const today00 = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const diff = Math.floor((today00 - startDate) / (1000 * 60 * 60 * 24));

  dDayText.textContent = `D+${diff + 1}`;
}

renderDDay(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ í‘œì‹œ

// ---------------- Firebase (ì „ì—­) ----------------
const firebaseConfig = {
  apiKey: "...",
  authDomain: "...",
  projectId: "...",
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let myUid = null;
let coupleId = null;

async function boot() {
  const cred = await auth.signInAnonymously();
  myUid = cred.user.uid;

  coupleId = localStorage.getItem("coupleId");
  if (!coupleId) {
    coupleId = prompt("ì»¤í”Œì½”ë“œ(ë‘˜ì´ë§Œ ì•„ëŠ” ê°’) ì…ë ¥")?.trim();
    if (!coupleId) return;
    localStorage.setItem("coupleId", coupleId);
  }

  const ref = db.collection("couples").doc(coupleId);
  await ref.set({
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    members: { [myUid]: true }
  }, { merge: true });

  // startEntriesListener();  // ì´ í•¨ìˆ˜ ë§Œë“  ë’¤ ì—¬ê¸°ì„œ í˜¸ì¶œ
}

boot();

   


  // ---------- Utilities ----------
  const $ = (id) => document.getElementById(id);
  const uid = () => Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
  const fmtKRW = (n) => (Number(n||0)).toLocaleString("ko-KR") + "ì›";
  const todayISO = () => new Date().toISOString().slice(0,10);

  // âœ… D-day helpers
function daysSince(yyyy_mm_dd){
  if(!yyyy_mm_dd) return 0;

  // ë¡œì»¬ ë‚ ì§œ ê¸°ì¤€(ì‹œê°„ ë•Œë¬¸ì— í•˜ë£¨ ë°€ë¦¬ëŠ” ê±° ë°©ì§€)
  const [y,m,d] = yyyy_mm_dd.split("-").map(Number);
  const start = new Date(y, m-1, d);
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  const diff = today.getTime() - start.getTime();
  return Math.floor(diff / (1000*60*60*24));
}


  function toast(msg){
    const t = $("toast");
    $("toastText").textContent = msg;
    t.classList.add("on");
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=>t.classList.remove("on"), 1400);
  }

  // ---------- Storage ----------
  const KEY_CODE = "couple_diary_code_v1";
  const KEY_DATA_PREFIX = "couple_diary_data_v1:";

  function getCoupleCode(){
    return localStorage.getItem(KEY_CODE) || "";
  }
  function setCoupleCode(code){
    localStorage.setItem(KEY_CODE, code);
  }
  function dataKey(code){
    return KEY_DATA_PREFIX + (code || "DEFAULT");
  }
  function loadData(code){
    const raw = localStorage.getItem(dataKey(code));
    if(!raw) return { coupleCode: code || "DEFAULT", entries: [] };
    try{
      const parsed = JSON.parse(raw);
      if(!parsed.entries) parsed.entries = [];
      return parsed;
    }catch{
      return { coupleCode: code || "DEFAULT", entries: [] };
    }
  }
  function saveData(code, data){
    localStorage.setItem(dataKey(code), JSON.stringify(data));
  }

  // ---------- App State ----------
  let coupleCode = getCoupleCode() || "DEFAULT";
  let data = loadData(coupleCode);
  let editingId = null;

  // ---------- Render ----------
  function moodClass(m){
    if(m==="good") return "good";
    if(m==="ok") return "ok";
    return "bad";
  }
  function moodLabel(m){
    if(m==="good") return "ì¢‹ìŒ ğŸ˜Š";
    if(m==="ok") return "ë³´í†µ ğŸ™‚";
    return "ë³„ë¡œ ğŸ˜¶";
  }

  function syncHeader(){
    $("coupleCodeLabel").textContent = coupleCode;
    $("subtitle").textContent = coupleCode === "DEFAULT"
      ? "ì»¤í”Œì½”ë“œë¥¼ ì„¤ì •í•˜ë©´ ë‘˜ë§Œì˜ ê³µê°„ìœ¼ë¡œ ë¶„ë¦¬ë¼ âœ¨"
      : "ë‘˜ë§Œì˜ ì½”ë“œë¡œ ì¶”ì–µì„ ìŒ“ëŠ” ì¤‘ ğŸ’";
  }

  function stats(){
    const entries = data.entries || [];
    $("kpiCount").textContent = entries.length.toLocaleString("ko-KR");
    const sum = entries.reduce((acc,e)=>acc + Number(e.cost||0), 0);
    $("kpiCost").textContent = fmtKRW(sum);
  }

  function filteredEntries(){
    const q = ($("q").value || "").trim().toLowerCase();
    const entries = [...(data.entries||[])];

    // ìµœì‹ ìˆœ ì •ë ¬ (ë‚ ì§œ desc)
    entries.sort((a,b)=> (b.date||"").localeCompare(a.date||""));

    if(!q) return entries;
    return entries.filter(e=>{
      const hay = [
        e.date, e.place, e.title, e.summary, e.content,
        (e.tags||[]).join(",")
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  function renderList(){
    const list = $("list");
    list.innerHTML = "";
    const entries = filteredEntries();

    $("empty").style.display = entries.length ? "none" : "block";

    for(const e of entries){
      const item = document.createElement("div");
      item.className = "item";

      const left = document.createElement("div");
      left.className = "meta";

      const top = document.createElement("div");
      top.className = "top";

      const dateTag = document.createElement("span");
      dateTag.className = "tag";
      dateTag.textContent = e.date || "-";

      const mood = document.createElement("span");
      mood.className = "tag mood " + moodClass(e.mood);
      mood.textContent = moodLabel(e.mood);

      const place = document.createElement("span");
      place.className = "tag";
      place.textContent = e.place ? ("ğŸ“ " + e.place) : "ğŸ“ (ì¥ì†Œ ì—†ìŒ)";

      top.append(dateTag, mood, place);

      const ttl = document.createElement("div");
      ttl.className = "ttl";
      ttl.textContent = e.title || "(ì œëª© ì—†ìŒ)";

      const desc = document.createElement("div");
      desc.className = "desc";
      desc.textContent = e.summary || e.content || "(ë‚´ìš© ì—†ìŒ)";

      const bottom = document.createElement("div");
      bottom.className = "top";

      const cost = document.createElement("span");
      cost.className = "tag";
      cost.textContent = "ğŸ’¸ " + fmtKRW(e.cost||0);

      bottom.append(cost);

      (e.tags||[]).slice(0,4).forEach(t=>{
        const tg = document.createElement("span");
        tg.className = "tag";
        tg.textContent = "#" + t;
        bottom.append(tg);
      });
      if((e.tags||[]).length > 4){
        const more = document.createElement("span");
        more.className = "tag";
        more.textContent = "+" + ((e.tags||[]).length-4);
        bottom.append(more);
      }

      left.append(top, ttl, desc, bottom);

      const actions = document.createElement("div");
      actions.className = "actions";

      const btnEdit = document.createElement("button");
      btnEdit.className = "btn";
      btnEdit.textContent = "í¸ì§‘";
      btnEdit.onclick = ()=> startEdit(e.id);

      const btnDel = document.createElement("button");
      btnDel.className = "btn danger";
      btnDel.textContent = "ì‚­ì œ";
      btnDel.onclick = ()=> removeEntry(e.id);

      actions.append(btnEdit, btnDel);

      item.append(left, actions);
      list.append(item);
    }

    stats();
  }

  // ---------- Form ----------
  function readForm(){
    const tags = ($("tags").value||"")
      .split(",").map(s=>s.trim()).filter(Boolean);
    return {
      id: editingId || uid(),
      date: $("date").value || todayISO(),
      place: $("place").value.trim(),
      title: $("title").value.trim(),
      mood: $("mood").value,
      summary: $("summary").value.trim(),
      content: $("content").value.trim(),
      tags,
      cost: Number($("cost").value || 0),
      coverImage: coverImageDataUrl || "",
      photos: photosDataUrls || [],

      updatedAt: new Date().toISOString(),
      createdAt: (editingId ? undefined : new Date().toISOString())
    };
  }

  function fillForm(e){
    $("date").value = e.date || todayISO();
    $("place").value = e.place || "";
    $("title").value = e.title || "";
    $("mood").value = e.mood || "good";
    $("summary").value = e.summary || "";
    $("content").value = e.content || "";
    $("tags").value = (e.tags||[]).join(", ");
    $("cost").value = e.cost || "";
  }

  function clearForm(){
    editingId = null;
    $("formTitle").textContent = "ìƒˆ ë°ì´íŠ¸ ê¸°ë¡";
    $("editHint").style.display = "none";
    fillForm({ date: todayISO(), mood:"good" });
  }

  function startEdit(id){
    const e = (data.entries||[]).find(x=>x.id===id);
    if(!e) return;
    editingId = id;
    $("formTitle").textContent = "ê¸°ë¡ í¸ì§‘";
    $("editHint").style.display = "block";
    fillForm(e);
    window.scrollTo({ top: 0, behavior: "smooth" });
    toast("í¸ì§‘ ëª¨ë“œ");
  }

  function upsertEntry(){
    const e = readForm();

    // validation lite
    if(!e.title){
      toast("ì œëª©ì„ í•œ ê¸€ìë¼ë„ ì¨ì¤˜!");
      $("title").focus();
      return;
    }

    const entries = data.entries || [];
    const idx = entries.findIndex(x=>x.id===e.id);
    if(idx >= 0){
      entries[idx] = { ...entries[idx], ...e, createdAt: entries[idx].createdAt || entries[idx].updatedAt };
    }else{
      entries.push(e);
    }
    data.entries = entries;
    saveData(coupleCode, data);
    renderList();
    clearForm();
    toast("ì €ì¥ ì™„ë£Œ");
  }

  function removeEntry(id){
    const e = (data.entries||[]).find(x=>x.id===id);
    if(!e) return;
    const ok = confirm(`ì‚­ì œí• ê¹Œ?\n\n${e.date || ""}  ${e.title || ""}`);
    if(!ok) return;
    data.entries = (data.entries||[]).filter(x=>x.id!==id);
    saveData(coupleCode, data);
    renderList();
    if(editingId === id) clearForm();
    toast("ì‚­ì œë¨");
  }

  // ---------- Export/Import ----------
  function doExport(){
    const payload = JSON.stringify({ coupleCode, entries: data.entries||[] }, null, 2);
    navigator.clipboard?.writeText(payload).then(()=>{
      toast("í´ë¦½ë³´ë“œì— ë³µì‚¬ë¨");
    }).catch(()=>{
      // fallback download
      const blob = new Blob([payload], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `couple-diary-${coupleCode}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
      toast("íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œë¨");
    });
  }

  function openImport(){
    $("importText").value = "";
    $("modalImport").classList.add("on");
  }
  function closeImport(){
    $("modalImport").classList.remove("on");
  }

  function parseImport(){
    const txt = $("importText").value.trim();
    if(!txt) throw new Error("ë¹ˆ ê°’");
    const obj = JSON.parse(txt);
    if(!obj.entries || !Array.isArray(obj.entries)) throw new Error("entries ì—†ìŒ");
    return obj;
  }

  function importMerge(){
    try{
      const obj = parseImport();
      const incoming = obj.entries.map(e=> ({...e, id: e.id || uid()} ));
      const map = new Map((data.entries||[]).map(e=>[e.id,e]));
      for(const e of incoming){
        if(!map.has(e.id)) map.set(e.id, e);
      }
      data.entries = Array.from(map.values());
      saveData(coupleCode, data);
      renderList();
      closeImport();
      toast("í•©ì¹˜ê¸° ì™„ë£Œ");
    }catch(err){
      alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err.message);
    }
  }

  function importReplace(){
    try{
      const obj = parseImport();
      const ok = confirm("ì •ë§ ë®ì–´ì“¸ê¹Œ? (ê¸°ì¡´ ê¸°ë¡ì´ ì‚¬ë¼ì§)");
      if(!ok) return;
      data.entries = obj.entries.map(e=> ({...e, id: e.id || uid()} ));
      saveData(coupleCode, data);
      renderList();
      closeImport();
      toast("ë®ì–´ì“°ê¸° ì™„ë£Œ");
    }catch(err){
      alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err.message);
    }
  }

  // ---------- Couple Code Modal ----------
  function openCoupleModal(){
    $("coupleCode").value = coupleCode === "DEFAULT" ? "" : coupleCode;
    $("modal").classList.add("on");
  }
  function closeCoupleModal(){
    $("modal").classList.remove("on");
  }
  function applyCoupleCode(){
    const code = ($("coupleCode").value || "").trim();
    coupleCode = code || "DEFAULT";
    setCoupleCode(coupleCode);
    data = loadData(coupleCode);
    saveData(coupleCode, data); // ensure exists
    syncHeader();
    clearForm();
    renderList();
    listenEntries();
    closeCoupleModal();
    toast("ì»¤í”Œì½”ë“œ ì ìš©ë¨");
  }

  // ---------- Reset ----------
  function resetAll(){
    const ok = confirm("ì´ˆê¸°í™”í• ê¹Œ?\ní˜„ì¬ ì»¤í”Œì½”ë“œ ê³µê°„ì˜ ê¸°ë¡ì´ ëª¨ë‘ ì‚­ì œë¼.");
    if(!ok) return;
    data = { coupleCode, entries: [] };
    saveData(coupleCode, data);
    clearForm();
    renderList();
    toast("ì´ˆê¸°í™” ì™„ë£Œ");
  }

  // ---------- Bind ----------
  $("btnSave").onclick = saveEntryToFirestore;
  $("coverImageInput").addEventListener("change", async (e) => {
  const file = e.target.files && e.target.files[0];
  coverImageDataUrl = file ? await fileToDataURL(file) : "";

  const img = $("coverPreview");
  if (coverImageDataUrl) {
    img.src = coverImageDataUrl;
    img.style.display = "block";
  } else {
    img.style.display = "none";
  }
});

$("photosInput").addEventListener("change", async (e) => {
  const files = Array.from(e.target.files || []);
  photosDataUrls = [];

  const wrap = $("photosPreview");
  wrap.innerHTML = "";

  for (const f of files) {
    const url = await fileToDataURL(f);
    photosDataUrls.push(url);

    const img = document.createElement("img");
    img.src = url;

    // âœ… ëª¨ë°”ì¼ ìµœì í™” ìŠ¤íƒ€ì¼
    img.style.width = "76px";
    img.style.height = "76px";
    img.style.objectFit = "cover";
    img.style.borderRadius = "10px";

    wrap.appendChild(img);
  }
});



  $("btnClear").onclick = clearForm;
  // ===== Images (in-memory) =====
let coverImageDataUrl = "";
let photosDataUrls = [];

function fileToDataURL(file){
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function handleCoverChange(e){
  const f = e.target.files && e.target.files[0];
  coverImageDataUrl = f ? await fileToDataURL(f) : "";
}

async function handlePhotosChange(e){
  const files = Array.from(e.target.files || []);
  photosDataUrls = [];
  for(const f of files){
    photosDataUrls.push(await fileToDataURL(f));
  }
}

$("coverImageInput").addEventListener("change", handleCoverChange);
$("photosInput").addEventListener("change", handlePhotosChange);

  $("q").oninput = renderList;

  $("btnExport").onclick = doExport;
  $("btnImport").onclick = openImport;

  $("btnCouple").onclick = openCoupleModal;
  $("btnClose").onclick = closeCoupleModal;
  $("btnSetCode").onclick = applyCoupleCode;

  $("btnCloseImport").onclick = closeImport;
  $("btnImportMerge").onclick = importMerge;
  $("btnImportReplace").onclick = importReplace;

  $("btnReset").onclick = resetAll;

  // init
  syncHeader();
  clearForm();
  // load data exists
  saveData(coupleCode, data);
  renderList();
  // âœ… D-day init
if ($("btnSaveAnniv")) {
  $("btnSaveAnniv").onclick = () => {
    const v = $("annivDate").value;
    if(!v) { alert("ì‚¬ê·„ ë‚  ë‚ ì§œë¥¼ ì„ íƒí•´ì¤˜!"); return; }
    localStorage.setItem("annivDate", v);
    renderDDay();
    toast?.("ì €ì¥ë¨"); // toast í•¨ìˆ˜ ìˆìœ¼ë©´ ëœ¸, ì—†ìœ¼ë©´ ë¬´ì‹œë¨
  };
}
if ($("annivDate")) {
  $("annivDate").addEventListener("change", renderDDay);
}
renderDDay();

  function getFormData() {
  // ë„ˆ HTML id ê¸°ì¤€(ìŠ¤í¬ë¦°ìƒ·ì—ì„œ date/place/title ë“± ë³´ì˜€ìŒ)
  const date = $("date")?.value || todayISO();
  const place = $("place")?.value || "";
  const title = $("title")?.value || "";
  const mood = $("mood")?.value || "";
  const summary = $("summary")?.value || "";
  const body = $("body")?.value || $("content")?.value || ""; // í˜¹ì‹œ ë³¸ë¬¸ idê°€ ë‹¤ë¥¼ ìˆ˜ ìˆì–´ì„œ
  const tags = ($("tags")?.value || "")
    .split(",")
    .map(s => s.trim())
    .filter(Boolean);
  const cost = Number(($("cost")?.value || "0").replace(/[^\d]/g, "")) || 0;

  // ì´ë¯¸ì§€(ë„ˆê°€ ì´ë¯¸ ë§Œë“¤ì–´ë‘” in-memory ë³€ìˆ˜ ì‚¬ìš©)
  // coverImageDataUrl, photosDataUrls ê°€ ì „ì—­ì— ìˆë‹¤ê³  í–ˆì§€? ì—†ìœ¼ë©´ ì•„ë˜ 2ì¤„ì€ ì§€ì›Œë„ ë¨.
  const cover = (typeof coverImageDataUrl !== "undefined") ? coverImageDataUrl : "";
  const photos = (typeof photosDataUrls !== "undefined") ? photosDataUrls : [];

  return { date, place, title, mood, summary, body, tags, cost, cover, photos };
}

async function saveEntryToFirestore() {
  if (!db || !coupleId || !myUid) {
    alert("ì•„ì§ ë¡œê·¸ì¸/ì»¤í”Œì½”ë“œ ì¤€ë¹„ê°€ ì•ˆ ëì–´. ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì¤˜!");
    return;
  }

  const data = getFormData();

  // ìˆ˜ì •/ì‹ ê·œ êµ¬ë¶„: (ë„ˆ ì½”ë“œì— editingId ê°™ì€ ê²Œ ìˆìœ¼ë©´ ê·¸ê±¸ ì“°ë©´ ë˜ê³ )
  // ì—†ìœ¼ë©´ ë¬´ì¡°ê±´ ì‹ ê·œë¡œ ì €ì¥
  const editingId = window.editingId || null;

  const ref = editingId
    ? db.collection("couples").doc(coupleId).collection("entries").doc(editingId)
    : db.collection("couples").doc(coupleId).collection("entries").doc();

  await ref.set({
    ...data,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdAt: editingId ? firebase.firestore.FieldValue.serverTimestamp() : firebase.firestore.FieldValue.serverTimestamp(),
    authorUid: myUid
  }, { merge: true });

  // ì €ì¥ ëë‚˜ë©´ í¸ì§‘ëª¨ë“œ í•´ì œ
  window.editingId = null;

  toast?.("ì €ì¥ë¨") || console.log("saved");
}
let unsubEntries = null;

function startEntriesListener() {
  if (!db || !coupleId) return;

  // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ìˆìœ¼ë©´ ëŠê¸°
  if (unsubEntries) unsubEntries();

  const q = db.collection("couples")
    .doc(coupleId)
    .collection("entries")
    .orderBy("date", "desc")
    .orderBy("updatedAt", "desc");

  unsubEntries = q.onSnapshot((snap) => {
    const entries = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderEntries(entries);
    renderStats(entries);
  }, (err) => {
    console.error(err);
    alert("ë¶ˆëŸ¬ì˜¤ê¸° ì—ëŸ¬: " + err.message);
  });
}

function renderEntries(entries) {
  // ë„ˆ ì•±ì˜ â€œê¸°ë¡ ëª©ë¡â€ ì˜ì—­ idê°€ ë­”ì§€ ëª°ë¼ì„œ 2ê°œ í›„ë³´ë¡œ ì²˜ë¦¬
  const listEl = $("list") || $("entries") || $("records") || $("entryList");

  if (!listEl) {
    console.log("entries:", entries);
    return;
  }

  listEl.innerHTML = "";

  if (!entries.length) {
    listEl.innerHTML = `<div class="empty">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´. ì™¼ìª½ì—ì„œ ì²« ë°ì´íŠ¸ ì¼ì§€ë¥¼ ì €ì¥í•´ë´!</div>`;
    return;
  }

  for (const e of entries) {
    const item = document.createElement("div");
    item.className = "item";

    item.innerHTML = `
      <div class="itemTop">
        <div class="itemTitle">${escapeHtml(e.title || "(ì œëª© ì—†ìŒ)")}</div>
        <div class="itemDate">${escapeHtml(e.date || "")}</div>
      </div>
      <div class="itemMeta">
        <span>${escapeHtml(e.place || "")}</span>
        <span>${escapeHtml(e.mood || "")}</span>
        <span>${e.cost ? `${Number(e.cost).toLocaleString("ko-KR")}ì›` : ""}</span>
      </div>
      ${e.summary ? `<div class="itemSummary">${escapeHtml(e.summary)}</div>` : ""}
      ${e.cover ? `<img class="itemCover" src="${e.cover}" />` : ""}
    `;

    item.onclick = () => loadEntryToForm(e);
    listEl.appendChild(item);
  }
}

function loadEntryToForm(e) {
  $("date") && ($("date").value = e.date || todayISO());
  $("place") && ($("place").value = e.place || "");
  $("title") && ($("title").value = e.title || "");
  $("mood") && ($("mood").value = e.mood || "");
  $("summary") && ($("summary").value = e.summary || "");
  ($("body") || $("content")) && ((($("body") || $("content")).value = e.body || ""));

  $("tags") && ($("tags").value = (e.tags || []).join(", "));
  $("cost") && ($("cost").value = e.cost || 0);

  // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°(ìˆëŠ” ê²½ìš°)
  if (typeof coverImageDataUrl !== "undefined") coverImageDataUrl = e.cover || "";
  if (typeof photosDataUrls !== "undefined") photosDataUrls = e.photos || [];

  const coverPreview = $("coverPreview");
  if (coverPreview && e.cover) {
    coverPreview.src = e.cover;
    coverPreview.style.display = "block";
  } else if (coverPreview) {
    coverPreview.style.display = "none";
  }

  const photosPreview = $("photosPreview");
  if (photosPreview) {
    photosPreview.innerHTML = "";
    (e.photos || []).forEach(url => {
      const img = document.createElement("img");
      img.src = url;
      img.style.width = "76px";
      img.style.height = "76px";
      img.style.objectFit = "cover";
      img.style.borderRadius = "10px";
      photosPreview.appendChild(img);
    });
  }

  window.editingId = e.id; // âœ… ë‹¤ìŒ ì €ì¥ì€ ìˆ˜ì •ìœ¼ë¡œ ë“¤ì–´ê°
}

function renderStats(entries) {
  // ë„ˆ UIì— â€œì´ ê¸°ë¡â€, â€œì´ ë¹„ìš©â€ ë°•ìŠ¤ê°€ ìˆë˜ë° idê°€ í”„ë¡œì íŠ¸ë§ˆë‹¤ ë‹¬ë¼ì„œ í›„ë³´ë¡œ ì²˜ë¦¬
  const totalCountEl = $("totalCount") || $("statCount");
  const totalCostEl = $("totalCost") || $("statCost");

  if (totalCountEl) totalCountEl.textContent = String(entries.length);

  const sum = entries.reduce((acc, e) => acc + (Number(e.cost) || 0), 0);
  if (totalCostEl) totalCostEl.textContent = `${sum.toLocaleString("ko-KR")}ì›`;
}

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, (m) => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
  }[m]));
}
let unsub = null;

function listenEntries() {
  if (unsub) unsub();

  const listEl = $("entryList");
  if (!listEl) {
    console.error("entryList ì—†ìŒ: <div id='entryList'></div> í™•ì¸");
    return;
  }

  unsub = db.collection("couples")
    .doc(coupleId)
    .collection("entries")
    .orderBy("date", "desc")
    .orderBy("updatedAt", "desc")
    .onSnapshot((snap) => {
      const entries = snap.docs.map(d => ({ id: d.id, ...d.data() }));

      listEl.innerHTML = entries.length
        ? entries.map(e => `
            <div class="item">
              <div class="itemTop">
                <div class="itemTitle">${escapeHtml(e.title || "(ì œëª©ì—†ìŒ)")}</div>
                <div class="itemDate">${escapeHtml(e.date || "")}</div>
              </div>
              <div class="itemMeta">
                <span>${escapeHtml(e.place || "")}</span>
                <span>${escapeHtml(e.mood || "")}</span>
                <span>${e.cost ? `${Number(e.cost).toLocaleString("ko-KR")}ì›` : ""}</span>
              </div>
              ${e.summary ? `<div class="itemSummary">${escapeHtml(e.summary)}</div>` : ""}
            </div>
          `).join("")
        : `<div class="empty">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´. ì™¼ìª½ì—ì„œ ì €ì¥í•´ë´!</div>`;
    }, (err) => {
      console.error("listenEntries ì—ëŸ¬:", err);
      alert("ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì—ëŸ¬: " + err.message);
    });
}

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, (m) => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
  }[m]));
}
$("btnAddPhotos").onclick = () => {
  $("photosInput").click();
};
// ===== D-day =====
const loveInput = $("loveStartDate");
const ddayCountEl = $("ddayCount");

// ë‚ ì§œ ì°¨ì´ ê³„ì‚°
function calcDDay(start) {
  const startDate = new Date(start);
  const today = new Date();
  const diff = today - startDate;
  return Math.floor(diff / (1000 * 60 * 60 * 24)) + 1;
}

// ì…ë ¥ ë³€ê²½ ì‹œ ì €ì¥
if (loveInput) {
  const saved = localStorage.getItem("loveStartDate");
  if (saved) loveInput.value = saved;

  loveInput.addEventListener("change", () => {
    localStorage.setItem("loveStartDate", loveInput.value);
    renderDDay();
  });
}

// ìµœì´ˆ í‘œì‹œ
renderDDay();
function getStartDate() {
  return localStorage.getItem("startDate"); // "YYYY-MM-DD"
}

function setStartDate(v) {
  localStorage.setItem("startDate", v);
}

function calcDDay(start) {
  const startDate = new Date(start + "T00:00:00");
  const today = new Date();
  const today00 = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const diff = Math.floor((today00 - startDate) / (1000 * 60 * 60 * 24));
  return diff >= 0 ? `D+${diff + 1}` : `D-${Math.abs(diff)}`; // ì‚¬ê·„ë‚ =1ì¼ë¡œ
}

function renderDDay() {
  const start = getStartDate();
  const ddayValue = document.getElementById("ddayValue");
  const ddaySub = document.getElementById("ddaySub");
  const input = document.getElementById("startDateInput");

  if (!start) {
    ddayValue.textContent = "D+0";
    ddaySub.textContent = "ê¸°ë…ì¼ì„ ì„¤ì •í•´ì¤˜";
    if (input) input.value = "";
    return;
  }

  ddayValue.textContent = calcDDay(start);
  ddaySub.textContent = `${start}ë¶€í„° ê¸°ë¡ ì¤‘`;
  if (input) input.value = start;
}

function openModal() {
  document.getElementById("ddayModal").classList.remove("hidden");
}
function closeModal() {
  const modal = document.getElementById("importModal"); // id ë§ê²Œ
  modal.style.display = "none";
}


document.addEventListener("DOMContentLoaded", () => {
  renderDDay();

  const openBtn = document.getElementById("openSettingBtn");
  const saveBtn = document.getElementById("saveStartDateBtn");
  const closeBtn = document.getElementById("closeModalBtn");

  openBtn?.addEventListener("click", openModal);

  saveBtn?.addEventListener("click", () => {
    const v = document.getElementById("startDateInput").value;
    if (!v) return alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì¤˜");
    setStartDate(v);
    renderDDay();
    closeModal();
  });

  closeBtn?.addEventListener("click", closeModal);

  // ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
  document.getElementById("ddayModal")?.addEventListener("click", (e) => {
    if (e.target.id === "ddayModal") closeModal();
  });
});
function closeImportModal() {
  const modal = document.getElementById("modalImport");
  if (modal) modal.style.display = "none";
}

const modalImport = document.getElementById("modalImport");
const btnCloseImport = document.getElementById("btnCloseImport");

// ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­í•˜ë©´ ë‹«ê¸°
if (modalImport) {
  modalImport.addEventListener("click", (e) => {
    if (e.target === modalImport) closeImportModal();
  });
}

// ë‹«ê¸° ë²„íŠ¼ í´ë¦­í•˜ë©´ ë‹«ê¸°
if (btnCloseImport) {
  btnCloseImport.addEventListener("click", closeImportModal);
}
const btnClose = document.getElementById("btnClose");
const modal = document.getElementById("modal");
if (btnClose && modal) btnClose.addEventListener("click", () => (modal.style.display = "none"));

// ===== storage key =====
function getCoupleId() {
  return (localStorage.getItem("coupleId") || "default").trim();
}
function getEntriesKey() {
  return `entries_${getCoupleId()}`;
}

// ===== load/save =====
function loadEntries() {
  try {
    return JSON.parse(localStorage.getItem(getEntriesKey()) || "[]");
  } catch {
    return [];
  }
}
function saveEntries(entries) {
  localStorage.setItem(getEntriesKey(), JSON.stringify(entries));
}

// ===== render =====
function renderEntries() {
  const list = document.getElementById("list");     // ë„ˆ ëª©ë¡ idì— ë§ê²Œ ìˆ˜ì •
  const empty = document.getElementById("empty");   // ë¹ˆ ìƒíƒœ ë¬¸êµ¬ id
  if (!list) return;

  const entries = loadEntries();
  if (empty) empty.style.display = entries.length ? "none" : "block";

  list.innerHTML = entries.map(e => `
    <div class="item">
      <div class="meta">
        <div class="top">
          <span class="tag">${e.date || ""}</span>
          ${e.mood ? `<span class="tag mood ${e.mood}">${e.mood}</span>` : ""}
        </div>
        <div class="ttl">${escapeHtml(e.title || "")}</div>
        <div class="desc">${escapeHtml(e.desc || "")}</div>
      </div>
    </div>
  `).join("");
}

// XSS ë°©ì§€ìš©(ê°„ë‹¨)
function escapeHtml(s) {
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// ===== save button =====
function wireSave() {
  const btnSave = document.getElementById("btnSave"); // ë„ˆ ì €ì¥ ë²„íŠ¼ idì— ë§ê²Œ ìˆ˜ì •
  if (!btnSave) return;

  btnSave.addEventListener("click", () => {
    // ë„ˆ ì…ë ¥ì¹¸ idì— ë§ê²Œ ìˆ˜ì •
    const title = document.getElementById("inpTitle")?.value?.trim() || "";
    const desc  = document.getElementById("inpDesc")?.value?.trim() || "";
    const date  = document.getElementById("inpDate")?.value || "";
    const mood  = document.getElementById("inpMood")?.value || "";

    if (!title && !desc) {
      alert("ë‚´ìš©ì„ ì…ë ¥í•´ì¤˜!");
      return;
    }

    const entries = loadEntries();
    entries.unshift({
      id: crypto.randomUUID(),
      title, desc, date, mood,
      createdAt: Date.now(),
    });

    saveEntries(entries);
    renderEntries();

    console.log("âœ… saved to", getEntriesKey(), entries[0]); // ë””ë²„ê·¸
  });
}

document.addEventListener("DOMContentLoaded", () => {
  wireSave();
  renderEntries();
});

}
const btnSaveAnniv = document.getElementById("btnSaveAnniv");
const inp = document.getElementById("annivDate"); // ì‚¬ê·„ ë‚  input

if (btnSaveAnniv) {
  btnSaveAnniv.addEventListener("click", () => {
    if (!inp || !inp.value) {
      alert("ì‚¬ê·„ ë‚  ë‚ ì§œë¥¼ ì„ íƒí•´ì¤˜!");
      return;
    }

    // âœ… ì €ì¥
    localStorage.setItem("annivDate", inp.value);

    // âœ… ë°”ë¡œ í™”ë©´ ê°±ì‹ 
    renderDDay();

    console.log("âœ… annivDate saved:", inp.value);
  });
}

</script>
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
  }
  document.addEventListener("DOMContentLoaded", renderDDay);

</script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

<script>
  function closeImport() {
    const modal = document.getElementById("modalImport");
    if (modal) {
      modal.classList.remove("on");
      modal.style.display = "none";
    }
  }
</script>

</body>
</html>